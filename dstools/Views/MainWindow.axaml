<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="using:dstools.ViewModels"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:converters="clr-namespace:dstools.Converters"
        mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="600"
        x:Class="dstools.Views.MainWindow"
        x:DataType="vm:MainWindowViewModel"
        xmlns:lucideAvalonia="clr-namespace:LucideAvalonia;assembly=LucideAvalonia"
        Icon="/Assets/avalonia-logo.ico"
        Title="DeepSeek部署工具"
        Width="500"
        Height="700">

    <Window.Resources>
        <converters:OllamaStatusConverter x:Key="OllamaStatusConverter" />
        <converters:OllamaNotInstalledConverter x:Key="OllamaNotInstalledConverter" />
        <converters:OllamaRunningStatusConverter x:Key="OllamaRunningStatusConverter" />
        <converters:DebugConverter x:Key="DebugConverter" />
    </Window.Resources>

    <Design.DataContext>
        <vm:MainWindowViewModel />
    </Design.DataContext>

    <Window.Styles>
            <Style Selector="Button.link">
            <Setter Property="Background" Value="Transparent" />
            <Setter Property="BorderThickness" Value="0" />
            <Setter Property="Padding" Value="5,0" />
        </Style>
        <Style Selector="Button.link:pointerover">
            <Setter Property="Background" Value="Transparent" />
            <Setter Property="Opacity" Value="0.7" />
        </Style>
        <Style Selector="Border.item">
            <Setter Property="Padding" Value="10" />
            <Setter Property="Margin" Value="5" />
            <Setter Property="Background" Value="#2D2D30" />
        </Style>
        <Style Selector="PathIcon">
            <Setter Property="Width" Value="20" />
            <Setter Property="Height" Value="20" />
            <Setter Property="Margin" Value="0,0,10,0" />
            <Setter Property="Foreground" Value="White" />
        </Style>
        <Style Selector="TextBlock.title">
            <Setter Property="Margin" Value="5, 0, 0, 0" />
            <Setter Property="VerticalAlignment" Value="Center" />
            <Setter Property="Width" Value="80" />
            <Setter Property="Foreground" Value="#888888" />
        </Style>
        <Style Selector="TextBlock.value">
            <Setter Property="VerticalAlignment" Value="Center" />
            <Setter Property="Foreground" Value="White" />
        </Style>
    </Window.Styles>

    <Border Background="#1E1E1E" Padding="10">
        <StackPanel>
            <!-- CPU -->
            <Border Classes="item">
                <Grid ColumnDefinitions="Auto, Auto, *">
                    <lucideAvalonia:Lucide Grid.Column="0" Icon="Cpu" StrokeBrush="White" StrokeThickness="1.5"
                                           Width="22" Height="22" />
                    <TextBlock Grid.Column="1" Classes="title" Text="处理器" />
                    <TextBlock Grid.Column="2" Classes="value" Text="{Binding HardwareInfo.CpuName}" />
                </Grid>
            </Border>

            <!-- GPU -->
            <Border Classes="item">
                <Grid ColumnDefinitions="Auto,Auto,*">
                    <lucideAvalonia:Lucide Grid.Column="0" Icon="Microchip" StrokeBrush="White" StrokeThickness="1.5"
                                           Width="22" Height="22" />
                    <TextBlock Grid.Column="1" Classes="title" Text="显卡" />
                    <StackPanel Grid.Column="2" Orientation="Horizontal">
                        <TextBlock Classes="value" Text="{Binding HardwareInfo.GpuName}" />
                        <TextBlock Classes="value" Text=" 显存：" />
                        <TextBlock Classes="value" Text="{Binding HardwareInfo.GpuMemory, StringFormat={}{0}G}" />
                    </StackPanel>
                </Grid>
            </Border>

            <!-- Memory -->
            <Border Classes="item">
                <Grid ColumnDefinitions="Auto,Auto,*">
                    <lucideAvalonia:Lucide Grid.Column="0" Icon="MemoryStick" StrokeBrush="White" StrokeThickness="1.5"
                                           Width="22" Height="22" />
                    <TextBlock Grid.Column="1" Classes="title" Text="内存" />
                    <TextBlock Grid.Column="2" Classes="value"
                               Text="{Binding HardwareInfo.TotalMemory, StringFormat={}{0:F0} GB}" />
                </Grid>
            </Border>

            <!-- Ollama -->
            <Border Classes="item">
                <StackPanel>
                    <Grid ColumnDefinitions="Auto,Auto,*">
                        <Border Grid.Column="0" Background="White" CornerRadius="4">
                            <Image Source="/Assets/ollama.png" Width="22" Height="22" />
                        </Border>
                        <TextBlock Grid.Column="1" Classes="title" Text="Ollama" />
                        <StackPanel Grid.Column="2" Orientation="Vertical">
                            <!-- 状态信息行 -->
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Classes="value" Text="安装状态：" />
                                <TextBlock Classes="value"
                                           Text="{Binding OllamaInfo.InstallStatus, Converter={StaticResource OllamaStatusConverter}}"
                                           FontSize="12" />
                                <TextBlock Classes="value" Text="   运行状态："
                                           IsVisible="{Binding OllamaInfo.InstallStatus, Converter={x:Static BoolConverters.Not}, ConverterParameter={StaticResource OllamaNotInstalledConverter}}" />
                                <TextBlock Classes="value"
                                           Text="{Binding OllamaInfo.RunningStatus, Converter={StaticResource OllamaStatusConverter}}"
                                           FontSize="12"
                                           IsVisible="{Binding OllamaInfo.InstallStatus, Converter={x:Static BoolConverters.Not}, ConverterParameter={StaticResource OllamaNotInstalledConverter}}" />
                            </StackPanel>
                            
                            <!-- 版本信息行 -->
                            <StackPanel Orientation="Horizontal" Margin="0,5,0,0"
                                        IsVisible="{Binding OllamaInfo.InstallStatus, Converter={x:Static BoolConverters.Not}, ConverterParameter={StaticResource OllamaNotInstalledConverter}}">
                                <TextBlock Classes="value" Text="版本：" />
                                <TextBlock Classes="value" Text="{Binding OllamaInfo.Version}" />
                            </StackPanel>
                            
                            <!-- 模型路径行 -->
                            <Grid ColumnDefinitions="Auto,*,Auto" Margin="0,5,0,0"
                                  IsVisible="{Binding OllamaInfo.InstallStatus, Converter={x:Static BoolConverters.Not}, ConverterParameter={StaticResource OllamaNotInstalledConverter}}">
                                <TextBlock Grid.Column="0" Classes="value" Text="模型安装路径：" />
                                <TextBlock Grid.Column="1" Classes="value" Text="{Binding OllamaInfo.ModelInstallPath}" 
                                           TextWrapping="Wrap" TextTrimming="CharacterEllipsis" 
                                           VerticalAlignment="Center" />
                                <Button Grid.Column="2" Content="更改" Command="{Binding SelectModelPathCommand}" 
                                        Classes="accent" Padding="5,2" />
                            </Grid>
                        </StackPanel>
                    </Grid>
                    
                    <!-- 操作按钮区域 -->
                    <StackPanel Orientation="Horizontal" Margin="0,10,0,0" HorizontalAlignment="Right">
                        <Button Classes="accent" Content="安装" Command="{Binding InstallOllamaCommand}"
                                Margin="0,0,10,0"
                                IsVisible="{Binding OllamaInfo.InstallStatus, Converter={StaticResource OllamaNotInstalledConverter}}" />
                        <ProgressBar Value="{Binding DownloadProgress}" Width="100" Height="2"
                                     IsVisible="{Binding IsDownloading}" Margin="0,0,10,0" />
                        <TextBlock Text="{Binding ErrorMessage}" Foreground="Red" IsVisible="{Binding HasError}"
                                   Margin="0,0,10,0" />
                        <Button Classes="accent" Content="启动" Command="{Binding StartOllamaCommand}"
                                IsVisible="{Binding OllamaInfo.InstallStatus, Converter={x:Static BoolConverters.Not}, ConverterParameter={StaticResource OllamaNotInstalledConverter}}"
                                IsEnabled="{Binding OllamaInfo.RunningStatus, Converter={StaticResource OllamaRunningStatusConverter}}"
                                Margin="0,0,10,0" />
                        <Button Classes="accent" Content="停止" Command="{Binding StopOllamaCommand}"
                                IsVisible="{Binding OllamaInfo.InstallStatus, Converter={x:Static BoolConverters.Not}, ConverterParameter={StaticResource OllamaNotInstalledConverter}}"
                                IsEnabled="{Binding OllamaInfo.RunningStatus, Converter={x:Static BoolConverters.Not}, ConverterParameter={StaticResource OllamaRunningStatusConverter}}" />
                    </StackPanel>
                    
                    <!-- 模型列表区域 -->
                    <StackPanel Margin="0,10,0,0"
                                IsVisible="{Binding OllamaInfo.InstallStatus, Converter={x:Static BoolConverters.Not}, ConverterParameter={StaticResource OllamaNotInstalledConverter}}">
                        <!-- 已安装模型列表 -->
                        <TextBlock Classes="value" Text="已安装模型：" Margin="0,0,0,5" />
                        <DataGrid ItemsSource="{Binding OllamaInfo.InstalledModels}" 
                                  MinHeight="100"
                                  AutoGenerateColumns="False"
                                  IsReadOnly="True"
                                  GridLinesVisibility="All"
                                  BorderThickness="1"
                                  BorderBrush="#2D2D30"
                                  Background="#1E1E1E"
                                  MaxHeight="150"
                                  CanUserResizeColumns="True"
                                  Margin="10,0,0,0"
                                  Foreground="White">
                            <DataGrid.Resources>
                                <SolidColorBrush x:Key="DataGridColumnHeaderBackgroundBrush" Color="#2D2D30"/>
                                <SolidColorBrush x:Key="DataGridColumnHeaderForegroundBrush" Color="White"/>
                                <SolidColorBrush x:Key="DataGridRowBackgroundBrush" Color="#1E1E1E"/>
                                <SolidColorBrush x:Key="DataGridRowForegroundBrush" Color="White"/>
                            </DataGrid.Resources>
                            <DataGrid.Columns>
                                <DataGridTextColumn Header="模型名称" 
                                                    Binding="{Binding Name}" 
                                                    Width="*" />
                                <DataGridTextColumn Header="大小" 
                                                    Binding="{Binding Size, StringFormat={}{0:N1}GB}" 
                                                    Width="100" />
                                <DataGridTextColumn Header="修改时间" 
                                                    Binding="{Binding ModifiedAt}" 
                                                    Width="150" />
                                <DataGridTemplateColumn Header="操作" Width="Auto">
                                    <DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate>
                                            <Button Content="删除"
                                                    Classes="accent"
                                                    Command="{Binding $parent[Window].((vm:MainWindowViewModel)DataContext).DeleteModelCommand}"
                                                    CommandParameter="{Binding Name}"
                                                    Margin="5,0" />
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellTemplate>
                                </DataGridTemplateColumn>
                            </DataGrid.Columns>
                        </DataGrid>

                        <!-- 可安装模型列表 -->
                        <TextBlock Classes="value" Text="可安装模型：" Margin="0,15,0,5" />
                        <DataGrid ItemsSource="{Binding OllamaInfo.AvailableModels}" 
                                  MinHeight="100"
                                  AutoGenerateColumns="False"
                                  IsReadOnly="True"
                                  GridLinesVisibility="All"
                                  BorderThickness="1"
                                  BorderBrush="#2D2D30"
                                  Background="#1E1E1E"
                                  MaxHeight="150"
                                  CanUserResizeColumns="True"
                                  Margin="10,0,0,0"
                                  Foreground="White">
                            <DataGrid.Resources>
                                <SolidColorBrush x:Key="DataGridColumnHeaderBackgroundBrush" Color="#2D2D30"/>
                                <SolidColorBrush x:Key="DataGridColumnHeaderForegroundBrush" Color="White"/>
                                <SolidColorBrush x:Key="DataGridRowBackgroundBrush" Color="#1E1E1E"/>
                                <SolidColorBrush x:Key="DataGridRowForegroundBrush" Color="White"/>
                            </DataGrid.Resources>
                            <DataGrid.Columns>
                                <DataGridTextColumn Header="模型名称" 
                                                    Binding="{Binding Name}" 
                                                    Width="*" />
                                <DataGridTextColumn Header="大小" 
                                                    Binding="{Binding Size, StringFormat={}{0:N1}GB}" 
                                                    Width="100" />
                                <DataGridTextColumn Header="描述" 
                                                    Binding="{Binding Description}" 
                                                    Width="150" />
                                <DataGridTemplateColumn Header="操作" Width="Auto">
                                    <DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate>
                                            <Button Content="安装"
                                             Classes="link"
                                                    Background="Transparent"
                                                    BorderThickness="0"
                                                    Foreground="#4D94FF"
                                                    Command="{Binding $parent[Window].((vm:MainWindowViewModel)DataContext).InstallModelCommand}"
                                                    CommandParameter="{Binding Url}"
                                                    Margin="5,0" />
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellTemplate>
                                </DataGridTemplateColumn>
                            </DataGrid.Columns>
                        </DataGrid>
                    </StackPanel>
                </StackPanel>
            </Border>
        </StackPanel>
    </Border>
</Window>